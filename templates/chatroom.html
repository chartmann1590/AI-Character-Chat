{% extends "base.html" %}
{% block title %}{{ room.title }} - Chatroom{% endblock %}
{% block content %}
<div class="mb-4">
  <h2>{{ room.title }}</h2>
  <p class="text-muted">{{ room.description }}</p>
  
  {% if bots|length > 0 %}
    <!-- Collapsible Bot Profile Card -->
    <div class="card mb-3">
      <div class="bot-profile-header" data-bs-toggle="collapse" data-bs-target="#botProfile" aria-expanded="false">
        <h5 class="mb-0">{{ bots[0].name }}'s Profile (click to expand)</h5>
      </div>
      <div id="botProfile" class="collapse">
        <div class="bot-profile-body">
          <div class="row">
            <div class="col-md-4">
              {% if bots[0].profile_pic %}
                <img src="{{ url_for('static', filename='uploads/' ~ bots[0].profile_pic) }}" class="img-fluid rounded" alt="{{ bots[0].name }}">
              {% else %}
                <img src="{{ url_for('static', filename='images/default_bot.png') }}" class="img-fluid rounded" alt="{{ bots[0].name }}">
              {% endif %}
            </div>
            <div class="col-md-8">
              <h5>{{ bots[0].name }}</h5>
              <p>{{ bots[0].bio or "No bio provided." }}</p>
              <p><small class="text-muted">Model: {{ bots[0].model }}</small></p>
              <!-- Edit Bot Model Modal Trigger -->
              <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editBotModal">
                Edit Bot Model
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<div class="row">
  <div class="col-12">
    <!-- Chat messages window -->
    <div id="chatWindow" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto;">
      {% for message in messages %}
        {% if message.sender == 'User' %}
          <div class="chat-message user-message">
            {% if user.profile_pic %}
              <img src="{{ url_for('static', filename='uploads/' ~ user.profile_pic) }}" alt="{{ user.username }}" class="chat-profile-pic">
            {% else %}
              <img src="{{ url_for('static', filename='images/default_user.png') }}" alt="{{ user.username }}" class="chat-profile-pic">
            {% endif %}
            <div class="chat-bubble user">
              <strong>{{ user.username }}:</strong> <span class="markdown">{{ message.content }}</span>
              <div class="message-timestamp">{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</div>
            </div>
          </div>
        {% else %}
          <div class="chat-message assistant-message">
            {% if bots|length > 0 and bots[0].profile_pic %}
              <img src="{{ url_for('static', filename='uploads/' ~ bots[0].profile_pic) }}" alt="{{ bots[0].name }}" class="chat-profile-pic">
            {% else %}
              <img src="{{ url_for('static', filename='images/default_bot.png') }}" alt="{{ bots[0].name if bots|length > 0 else 'Assistant' }}" class="chat-profile-pic">
            {% endif %}
            <div class="chat-bubble assistant">
              <strong>{{ bots[0].name if bots|length > 0 else 'Assistant' }}:</strong> <span class="markdown">{{ message.content }}</span>
              <div class="message-timestamp">{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
    
    <!-- Message form -->
    <form id="messageForm" action="{{ url_for('room', room_id=room.id) }}" method="POST">
      <div class="input-group">
        <input type="text" id="messageInput" class="form-control" name="message" placeholder="Type your message..." required>
        <button class="btn btn-primary" type="submit">Send</button>
      </div>
    </form>
    
    <!-- Reset Chat Form -->
    <form id="resetForm" action="{{ url_for('reset_chat', room_id=room.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to reset the chat? This will clear the entire conversation history.');" class="mt-3">
      <button type="submit" class="btn btn-warning">Reset Chat</button>
    </form>
  </div>
</div>

<div class="mt-3">
  <a href="{{ url_for('index') }}" class="btn btn-secondary">&larr; Back to Chatrooms</a>
</div>

<!-- Edit Bot Model Modal -->
{% if bots|length > 0 %}
<div class="modal fade" id="editBotModal" tabindex="-1" aria-labelledby="editBotModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editBotForm" action="{{ url_for('edit_bot', bot_id=bots[0].id) }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="editBotModalLabel">Edit Bot Model</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="modelSelect" class="form-label">Select New Model</label>
            <select class="form-select" id="modelSelect" name="model" required>
              {% if models|length > 0 %}
                {% for model in models %}
                  <option value="{{ model.name }}" {% if model.name == bots[0].model %}selected{% endif %}>
                    {{ model.name }}
                  </option>
                {% endfor %}
              {% else %}
                <option value="llama3.2" selected>llama3.2</option>
              {% endif %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script>
    // Helper function: parse and conditionally bold markdown text.
    function processMarkdown(rawText) {
    let isThought = false;
    let text = rawText;
    // Check if message starts with the marker "[thought]"
    if (rawText.trim().startsWith("[thought]")) {
        isThought = true;
        // Remove the marker from the text.
        text = rawText.trim().substring(9).trim();
    }
    const parsed = marked.parse(text);
    if (isThought) {
        // Wrap the result in a span with a custom class that makes it bold.
        return `<span class="markdown-bold">${parsed}</span>`;
    } else {
        return parsed;
    }
}
      
    // Apply conversion on page load for any existing messages.
    document.addEventListener("DOMContentLoaded", function() {
      document.querySelectorAll(".markdown").forEach(function(element) {
        // Use the raw markdown (taken from innerText) and apply processMarkdown.
        element.innerHTML = processMarkdown(element.innerText);
      });
    });
    
    // Retrieve the bot's name from the template.
    var botName = "{{ bots[0].name if bots|length > 0 else 'Assistant' }}";
    
    function scrollChatToBottom() {
      var chatWindow = document.getElementById("chatWindow");
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    scrollChatToBottom();
    
    document.getElementById("messageForm").addEventListener("submit", async function(event) {
      event.preventDefault();
      const input = document.getElementById("messageInput");
      const rawMessageText = input.value.trim();
      if (!rawMessageText) return;
    
      // Process markdown for the user's message.
      const messageHTML = processMarkdown(rawMessageText);
    
      const chatWindow = document.getElementById("chatWindow");
      const userMessageDiv = document.createElement("div");
      userMessageDiv.classList.add("chat-message", "user-message");
      userMessageDiv.innerHTML = `
        <img src="{{ url_for('static', filename='uploads/' ~ (user.profile_pic if user and user.profile_pic else 'images/default_user.png')) }}" 
             alt="{{ user.username }}" class="chat-profile-pic">
        <div class="chat-bubble user">
          <strong>{{ user.username }}:</strong> <span class="markdown">${messageHTML}</span>
          <div class="message-timestamp">${new Date().toLocaleString()}</div>
        </div>`;
      chatWindow.appendChild(userMessageDiv);
      scrollChatToBottom();
      input.value = "";
    
      // Append a typing indicator for the bot.
      const typingIndicator = document.createElement("div");
      typingIndicator.setAttribute("id", "typingIndicator");
      typingIndicator.classList.add("chat-message", "assistant-message");
      typingIndicator.innerHTML = `
        <img src="{{ url_for('static', filename='uploads/' ~ (bots[0].profile_pic if bots|length > 0 and bots[0].profile_pic else 'images/default_bot.png')) }}" 
             alt="${botName}" class="chat-profile-pic">
        <div class="chat-bubble assistant">
          <strong>${botName} is typing...</strong>
        </div>`;
      chatWindow.appendChild(typingIndicator);
      scrollChatToBottom();
    
      try {
        const response = await fetch("{{ url_for('room', room_id=room.id) }}", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({ "message": rawMessageText })
        });
        const data = await response.json();
        if (typingIndicator && typingIndicator.parentNode) {
          typingIndicator.parentNode.removeChild(typingIndicator);
        }
        const botMessageHTML = processMarkdown(data.bot_message);
        const botMessageDiv = document.createElement("div");
        botMessageDiv.classList.add("chat-message", "assistant-message");
        botMessageDiv.innerHTML = `
          <img src="{{ url_for('static', filename='uploads/' ~ (bots[0].profile_pic if bots|length > 0 and bots[0].profile_pic else 'images/default_bot.png')) }}" 
               alt="${data.sender}" class="chat-profile-pic">
          <div class="chat-bubble assistant">
            <strong>${data.sender}:</strong> <span class="markdown">${botMessageHTML}</span>
            <div class="message-timestamp">${new Date().toLocaleString()}</div>
          </div>`;
        chatWindow.appendChild(botMessageDiv);
        scrollChatToBottom();
      } catch (error) {
        console.error("Error sending message:", error);
        if (typingIndicator && typingIndicator.parentNode) {
          typingIndicator.parentNode.removeChild(typingIndicator);
        }
      }
    });
  </script>  
{% endblock %}
